name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Create Release with Auto-Generated Notes
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Free disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo "Disk space after cleanup:"
          df -h

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Update version in build.gradle.kts
        run: |
          sed -i "s/version = \".*\"/version = \"${{ steps.get_version.outputs.VERSION }}\"/" build.gradle.kts
          cat build.gradle.kts | grep "version = "

      - name: Build plugin
        run: ./gradlew buildPlugin

      - name: Run tests
        run: ./gradlew test

      - name: Generate categorized release notes
        id: release_notes
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git tag --sort=-creatordate | grep -v "^${{ github.ref_name }}$" | head -n 1)

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, using initial commit"
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "Generating release notes from $PREVIOUS_TAG to ${{ github.ref_name }}"

          # Count commits
          COMMIT_COUNT=$(git log $PREVIOUS_TAG..${{ github.ref_name }} --oneline | wc -l)
          echo "Found $COMMIT_COUNT commits"

          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "Warning: No commits found between $PREVIOUS_TAG and ${{ github.ref_name }}"
          fi

          # Initialize release notes file
          cat > release_notes.md << 'EOF'
          ## What's Changed

          EOF

          # Categorize commits
          declare -A categories
          categories[feat]="### âœ¨ New Features"
          categories[fix]="### ðŸ› Bug Fixes"
          categories[docs]="### ðŸ“ Documentation"
          categories[style]="### ðŸ’„ Style Changes"
          categories[refactor]="### â™»ï¸ Code Refactoring"
          categories[perf]="### âš¡ Performance Improvements"
          categories[test]="### âœ… Tests"
          categories[build]="### ðŸ”§ Build System"
          categories[ci]="### ðŸ‘· CI/CD"
          categories[chore]="### ðŸ”¨ Chores"
          categories[other]="### ðŸ“¦ Other Changes"

          # Temporary files for each category
          for key in "${!categories[@]}"; do
            > /tmp/commits_$key.txt
          done

          # Parse commits and categorize them
          while IFS='|||' read -r message hash author; do
            # Extract conventional commit type
            if [[ $message =~ ^([a-z]+)(\(.+\))?:\ (.+)$ ]]; then
              type="${BASH_REMATCH[1]}"
              scope="${BASH_REMATCH[2]}"
              description="${BASH_REMATCH[3]}"

              # Capitalize first letter of description
              description="$(tr '[:lower:]' '[:upper:]' <<< ${description:0:1})${description:1}"

              if [[ -n "${categories[$type]}" ]]; then
                echo "- $description ($hash)" >> /tmp/commits_$type.txt
              else
                echo "- $message ($hash)" >> /tmp/commits_other.txt
              fi
            else
              # Not a conventional commit, put in other
              echo "- $message ($hash)" >> /tmp/commits_other.txt
            fi
          done < <(git log $PREVIOUS_TAG..${{ github.ref_name }} --pretty=format:"%s|||%h|||%an")

          # Append categorized commits to release notes
          HAS_COMMITS=false
          for key in feat fix docs style refactor perf test build ci chore other; do
            if [ -s /tmp/commits_$key.txt ]; then
              HAS_COMMITS=true
              echo "" >> release_notes.md
              echo "${categories[$key]}" >> release_notes.md
              echo "" >> release_notes.md
              cat /tmp/commits_$key.txt >> release_notes.md
            fi
          done

          # Add message if no commits found
          if [ "$HAS_COMMITS" = false ]; then
            echo "" >> release_notes.md
            echo "No categorized changes in this release." >> release_notes.md
            echo "" >> release_notes.md
          fi

          # Add contributors
          echo "" >> release_notes.md
          echo "### ðŸ‘¥ Contributors" >> release_notes.md
          echo "" >> release_notes.md
          while read author; do
            echo "- $author" >> release_notes.md
          done < <(git log $PREVIOUS_TAG..${{ github.ref_name }} --pretty=format:"%an" | sort -u)

          # Add installation instructions
          cat >> release_notes.md << 'EOF'

          ## ðŸ“¥ Installation

          ### From JetBrains Marketplace (Recommended)
          1. Open your JetBrains IDE (IntelliJ IDEA, WebStorm, PyCharm, etc.)
          2. Go to **Settings/Preferences** > **Plugins**
          3. Search for "Jenkinsfile"
          4. Click **Install** and restart your IDE

          ### Manual Installation
          1. Download the plugin ZIP file from the assets below
          2. Go to **Settings/Preferences** > **Plugins**
          3. Click the gear icon âš™ï¸ and select **Install Plugin from Disk...**
          4. Select the downloaded `.zip` file
          5. Restart your IDE

          ## ðŸ”— Links

          EOF

          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ github.ref_name }}" >> release_notes.md

          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "If you find this plugin useful, please â­ star the repository and share it with others!" >> release_notes.md

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            build/distributions/*.zip
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
