name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Create Release with Auto-Generated Notes
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Free disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo "Disk space after cleanup:"
          df -h

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Update version in build.gradle.kts
        run: |
          sed -i "s/version = \".*\"/version = \"${{ steps.get_version.outputs.VERSION }}\"/" build.gradle.kts
          cat build.gradle.kts | grep "version = "

      - name: Generate changelogs (HTML + Markdown)
        id: generate_changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git tag --sort=-creatordate | grep -v "^${{ github.ref_name }}$" | head -n 1)

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, using initial commit"
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "Generating changelogs from $PREVIOUS_TAG to ${{ github.ref_name }}"

          # Count commits
          COMMIT_COUNT=$(git log $PREVIOUS_TAG..${{ github.ref_name }} --oneline | wc -l)
          echo "Found $COMMIT_COUNT commits"

          # Category mappings for both HTML and Markdown
          declare -A html_categories md_categories
          html_categories[feat]="New Features"
          html_categories[fix]="Bug Fixes"
          html_categories[docs]="Documentation"
          html_categories[perf]="Performance Improvements"
          html_categories[style]="Style Changes"
          html_categories[refactor]="Code Refactoring"
          html_categories[test]="Tests"
          html_categories[build]="Build System"
          html_categories[ci]="CI/CD"
          html_categories[chore]="Chores"

          md_categories[feat]="### âœ¨ New Features"
          md_categories[fix]="### ðŸ› Bug Fixes"
          md_categories[docs]="### ðŸ“ Documentation"
          md_categories[perf]="### âš¡ Performance Improvements"
          md_categories[style]="### ðŸ’„ Style Changes"
          md_categories[refactor]="### â™»ï¸ Code Refactoring"
          md_categories[test]="### âœ… Tests"
          md_categories[build]="### ðŸ”§ Build System"
          md_categories[ci]="### ðŸ‘· CI/CD"
          md_categories[chore]="### ðŸ”¨ Chores"

          # Create temp files for each category
          for key in feat fix docs perf style refactor test build ci chore; do
            > /tmp/commits_$key.txt
          done
          > /tmp/commits_other.txt

          # Parse and categorize commits (single pass)
          declare -A authors
          while IFS='|||' read -r message hash author; do
            authors["$author"]=1

            if [[ $message =~ ^([a-z]+)(\(.+\))?:\ (.+)$ ]]; then
              type="${BASH_REMATCH[1]}"
              description="${BASH_REMATCH[3]}"
              description="$(tr '[:lower:]' '[:upper:]' <<< ${description:0:1})${description:1}"

              if [[ -n "${html_categories[$type]}" ]]; then
                # Store both HTML and MD format in same file
                echo "$type|||$description|||$hash" >> /tmp/commits_$type.txt
              else
                echo "other|||$message|||$hash" >> /tmp/commits_other.txt
              fi
            else
              echo "other|||$message|||$hash" >> /tmp/commits_other.txt
            fi
          done < <(git log $PREVIOUS_TAG..${{ github.ref_name }} --pretty=format:"%s|||%h|||%an")

          # ========== Generate HTML Changelog ==========
          cat > /tmp/new_changelog.html << 'CHANGELOG_START'
            <h3>${{ steps.get_version.outputs.VERSION }}</h3>
            <ul>
          CHANGELOG_START

          HAS_HTML_COMMITS=false
          for key in feat fix perf docs style refactor test build ci chore; do
            if [ -s /tmp/commits_$key.txt ]; then
              HAS_HTML_COMMITS=true
              echo "                <li><b>${html_categories[$key]}</b>" >> /tmp/new_changelog.html
              echo "                    <ul>" >> /tmp/new_changelog.html
              while IFS='|||' read -r type description hash; do
                echo "                        <li>$description</li>" >> /tmp/new_changelog.html
              done < /tmp/commits_$key.txt
              echo "                    </ul>" >> /tmp/new_changelog.html
              echo "                </li>" >> /tmp/new_changelog.html
            fi
          done

          # Add other commits to HTML
          if [ -s /tmp/commits_other.txt ]; then
            while IFS='|||' read -r type description hash; do
              echo "                <li>$description</li>" >> /tmp/new_changelog.html
            done < /tmp/commits_other.txt
          fi

          echo "            </ul>" >> /tmp/new_changelog.html
          echo "" >> /tmp/new_changelog.html

          echo "Generated HTML changelog:"
          cat /tmp/new_changelog.html

          # ========== Generate Markdown Release Notes ==========
          cat > release_notes.md << 'EOF'
          ## What's Changed

          EOF

          HAS_MD_COMMITS=false
          for key in feat fix docs style refactor perf test build ci chore; do
            if [ -s /tmp/commits_$key.txt ]; then
              HAS_MD_COMMITS=true
              echo "" >> release_notes.md
              echo "${md_categories[$key]}" >> release_notes.md
              echo "" >> release_notes.md
              while IFS='|||' read -r type description hash; do
                echo "- $description ($hash)" >> release_notes.md
              done < /tmp/commits_$key.txt
            fi
          done

          # Add other commits to Markdown
          if [ -s /tmp/commits_other.txt ]; then
            HAS_MD_COMMITS=true
            echo "" >> release_notes.md
            echo "### ðŸ“¦ Other Changes" >> release_notes.md
            echo "" >> release_notes.md
            while IFS='|||' read -r type description hash; do
              echo "- $description ($hash)" >> release_notes.md
            done < /tmp/commits_other.txt
          fi

          if [ "$HAS_MD_COMMITS" = false ]; then
            echo "" >> release_notes.md
            echo "No categorized changes in this release." >> release_notes.md
          fi

          # Add contributors
          echo "" >> release_notes.md
          echo "### ðŸ‘¥ Contributors" >> release_notes.md
          echo "" >> release_notes.md
          for author in "${!authors[@]}"; do
            echo "- $author" >> release_notes.md
          done

          # Add installation instructions
          cat >> release_notes.md << 'EOF'

          ## ðŸ“¥ Installation

          ### From JetBrains Marketplace (Recommended)
          1. Open your JetBrains IDE (IntelliJ IDEA, WebStorm, PyCharm, etc.)
          2. Go to **Settings/Preferences** > **Plugins**
          3. Search for "Jenkinsfile"
          4. Click **Install** and restart your IDE

          ### Manual Installation
          1. Download the plugin ZIP file from the assets below
          2. Go to **Settings/Preferences** > **Plugins**
          3. Click the gear icon âš™ï¸ and select **Install Plugin from Disk...**
          4. Select the downloaded `.zip` file
          5. Restart your IDE

          ## ðŸ”— Links

          EOF

          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ github.ref_name }}" >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "If you find this plugin useful, please â­ star the repository and share it with others!" >> release_notes.md

          echo ""
          echo "Generated Markdown release notes:"
          cat release_notes.md

      - name: Update changeNotes in build.gradle.kts
        run: |
          # Create a Python script to update the changeNotes
          cat > /tmp/update_changelog.py << 'PYTHON_SCRIPT'
          import re

          with open('build.gradle.kts', 'r') as f:
              content = f.read()

          # Read the new changelog
          with open('/tmp/new_changelog.html', 'r') as f:
              new_changelog = f.read()

          # Find and replace the changeNotes section
          pattern = r'(changeNotes = """)\s*(.*?)(\s*""".trimIndent\(\))'

          def replace_changelog(match):
              existing = match.group(2).strip()
              # Prepend new changelog to existing
              updated = new_changelog + existing
              return match.group(1) + '\n' + updated + match.group(3)

          content = re.sub(pattern, replace_changelog, content, flags=re.DOTALL)

          with open('build.gradle.kts', 'w') as f:
              f.write(content)
          PYTHON_SCRIPT

          python3 /tmp/update_changelog.py

          echo "Updated build.gradle.kts changeNotes:"
          grep -A 20 "changeNotes = " build.gradle.kts | head -25

      - name: Build plugin
        run: ./gradlew buildPlugin

      - name: Run tests
        run: ./gradlew test

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            build/distributions/*.zip
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
