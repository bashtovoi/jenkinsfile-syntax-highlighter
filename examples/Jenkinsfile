// Jenkins Pipeline Example
pipeline {
    agent any

    environment {
        VERSION = '1.0.0'
        BUILD_NUMBER = "${env.BUILD_NUMBER}"
        DOCKER_REGISTRY = 'registry.example.com'
        GIT_REPO_NAME = 'my-application'
        SLACK_CHANNEL = '#builds'
        SONAR_URL = 'https://sonar.example.com'
    }

    options {
        timeout(time: 1, unit: 'HOURS')
        timestamps()
        ansiColor('xterm')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
    }

    parameters {
        string(name: 'BRANCH_NAME', defaultValue: 'main', description: 'Branch to build')
        booleanParam(name: 'RUN_TESTS', defaultValue: true, description: 'Run tests?')
        choice(name: 'TARGET_ENV', choices: ['dev', 'staging', 'prod'], description: 'Target environment')
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Checking out ${GIT_REPO_NAME} from branch ${params.BRANCH_NAME}..."
                git branch: params.BRANCH_NAME, url: "https://github.com/example/${GIT_REPO_NAME}.git"
            }
        }

        stage('Build') {
            options {
                timeout(time: 30, unit: 'MINUTES')
            }
            steps {
                echo "Building ${GIT_REPO_NAME} version ${VERSION}..."
                echo 'Build process starting...'
                echo 'Build completed successfully'
            }
        }

        stage('Test') {
            when {
                expression { return params.RUN_TESTS }
            }
            steps {
                echo 'Running tests...'
                junit 'target/surefire-reports/*.xml'
                archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
            }
        }

        stage('Docker Build') {
            steps {
                echo "Building Docker image ${DOCKER_REGISTRY}/myapp:${VERSION}"
                docker.build("${DOCKER_REGISTRY}/myapp:${VERSION}")
            }
        }

        stage('Deploy') {
            when {
                branch 'main'
                environment name: 'ENVIRONMENT', value: 'prod'
            }
            steps {
                timeout(time: 10, unit: 'MINUTES') {
                    echo "Deploying to ${params.ENVIRONMENT}..."

                    withCredentials([usernamePassword(
                        credentialsId: 'docker-creds',
                        usernameVariable: 'USER',
                        passwordVariable: 'PASS'
                    )]) {
                        echo 'Pushing Docker image...'
                        docker.withRegistry("https://${DOCKER_REGISTRY}", 'docker-creds') {
                            echo "Pushed ${DOCKER_REGISTRY}/myapp:${VERSION}"
                        }
                    }
                }
            }
        }

        stage('Integration Tests') {
            parallel {
                stage('API Tests') {
                    steps {
                        echo 'Running API tests...'
                        echo 'API tests completed'
                    }
                }
                stage('UI Tests') {
                    steps {
                        echo 'Running UI tests...'
                        echo 'UI tests completed'
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline completed'
            deleteDir() // Clean workspace
        }
        success {
            echo 'Pipeline succeeded!'
            mail to: 'team@example.com',
                 subject: "Build Success - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: "The build was successful!"
        }
        failure {
            echo 'Pipeline failed!'
            mail to: 'team@example.com',
                 subject: "Build Failed - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: "The build failed. Please check the logs."
        }
        unstable {
            echo 'Pipeline unstable'
        }
    }
}
